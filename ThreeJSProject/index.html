<html>

<head>
    <title>threejs - models</title>

    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>

    <script src="js/three.js"></script>
    <script src="js/GLTFLoader.js"></script>
    <script src="js/FBXLoader.js"></script>
    <script src="js/inflate.min.js"></script>
    <script src="js/PointerLockControls.js"></script>
    <script src="js/OrbitControls.js"></script>
</head>

<body>

    <canvas id="myCanvas"></canvas>

    <script>
        var renderer,
        bulbLight,
            clock,
            scene,
            camera,
            mixer,
            testZombie,
            myCanvas = document.getElementById('myCanvas');
        var timeFixed = 0;
        function init() {
            //SCENE
            scene = new THREE.Scene();
            //RENDERER
            renderer = new THREE.WebGLRenderer({
                canvas: myCanvas,
                antialias: true
            });
            renderer.setClearColor(0x00000);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            //CAMERA
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 1.7, 0);
            //CLOCK
            clock = new THREE.Clock();

            var controls = new THREE.PointerLockControls(camera);
            myCanvas.addEventListener('click', function () {
                controls.lock();
            });
            window.addEventListener('resize', function () {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            }
            );
            //var controls = new THREE.OrbitControls(camera, renderer.domElement);
            start();
        }

        function setupMap(scene) {
            let loader = new THREE.GLTFLoader();
            var mesh;
            loader.load('models/Map.glb', function (gltf) {
                mesh = gltf.scene;
                mesh.children[0].material = new THREE.MeshStandardMaterial( {
					roughness: 0.7,
					color: 0xffffff,
					metalness: 0.2
				} );
                scene.add(mesh);
                mesh.position.set(1.5, 0, 1.5);
            });
        }

        function loadZombie(scene){
            var loader = new THREE.FBXLoader();
            loader.load( './test.fbx', function ( object ) {
                object.position.set(0,0,-10);
                object.scale.set(0.022,0.022,0.022);
                
                mixer = new THREE.AnimationMixer( object );

                object.traverse( function ( child ) {
                    if ( child.isMesh ) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                } );
                mixer.clipAction( object.animations[1] ).play();
                scene.add( object );
                testZombie = object;
            }, undefined, function ( e ) {
                console.error( e );
            } );
        }
        function setupLights(scene) {
            var bulbGeometry = new THREE.SphereBufferGeometry( 0.02, 16, 8 );
            bulbLight = new THREE.PointLight( 0xcc3333, 1, 100, 35);

            bulbMat = new THREE.MeshStandardMaterial( {
                emissive: 0xcc3333,
                emissiveIntensity: 1,
                color: 0x000000
            } );
            bulbLight.add( new THREE.Mesh( bulbGeometry, bulbMat ) );
            bulbLight.position.set( 0, 2.5, 0 );
            bulbLight.castShadow = true;
            scene.add( bulbLight );
        }
        function gameLoop() {
            requestAnimationFrame(gameLoop);
            timeFixed += clock.getDelta();

            update();
            render();
        }
        function start() {
            setupMap(scene);
            setupLights(scene);
            loadZombie(scene);
        }
        var wait = 0;
        function update() {
            bulbLight.intensity = 2 * Math.sin(timeFixed) + 3;
            
            var delta = clock.getDelta();

            //update Zombie
            if ( mixer ) mixer.update( 1/30 );
            if(testZombie){ 
                if(wait>0){
                    wait -= 1/30;
                }else{
                    wait = -1;
                    mixer.clipAction( testZombie.animations[0] ).play();
                }
                if(wait == -1){
                    testZombie.translateZ(0.08);
                }
                if (testZombie.position.z > -1) {
                    wait = Math.random()*10.0 + 5.0;
                    testZombie.position.z = -10;
                    mixer.stopAllAction();
                    mixer.clipAction( testZombie.animations[1] ).play();
                }
            }
        }
        function render() {
            renderer.render(scene, camera);
        }

        init();
        gameLoop();



    </script>
</body>

</html>